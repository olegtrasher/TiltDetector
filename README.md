# Pitch Detector - HorizonNet

Скрипт для автоматического определения угла наклона камеры (pitch) по фотографии с помощью нейронной сети HorizonNet.

## Описание

Этот проект позволяет определить вертикальный угол наклона камеры (pitch) по стереофотографии, снятой камерой с объективом 180°. Скрипт автоматически:

1. Разделяет стереопару пополам и использует левую часть
2. Ресайзит изображение до формата 1024x512
3. Анализирует изображение с помощью HorizonNet
4. Вычисляет угол pitch на основе сигнала горизонта
5. Предоставляет удобный GUI интерфейс

## Требования

- Python 3.7+
- PyTorch 1.9+
- OpenCV 4.5+
- NumPy 1.21+
- Pillow 8.3+
- Matplotlib 3.4+
- SciPy 1.7+

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd TiltDetector
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Убедитесь, что в папке `pretrained_models/` находятся файлы весов модели:
   - `resnet50_rnn__zind.pth` (рекомендуется)
   - `resnet50_rnn__panos2d3d.pth`
   - `resnet50_rnn__st3d.pth`
   - `resnet50_rnn__mp3d.pth`

## Скачивание весов моделей

**Веса моделей (.pth) можно скачать здесь:**
https://github.com/sunset1995/HorizonNet#pretrained-models

Скачайте нужный .pth-файл и поместите его в папку `pretrained_models/`.

## Использование

### Запуск GUI приложения

```bash
python pitch_detector.py
```

### Интерфейс

Приложение предоставляет следующий интерфейс:

- **Выбрать изображение** - выбор стереофотографии для анализа
- **Resize + Crop** - предобработка изображения (разделение и ресайз)
- **Detect Pitch** - определение угла наклона камеры
- **Результаты** - отображение результатов анализа
- **Изображение** - предварительный просмотр обработанного изображения

### Формат входных данных

- Стереофотография размером 8192x4096 пикселей
- Левая половина - изображение одного глаза/объектива (180°)
- Правая половина - изображение второго глаза/объектива
- Поддерживаемые форматы: PNG, JPG, JPEG, BMP, TIFF

### Интерпретация результатов

- **Pitch угол** - угол наклона камеры в градусах
- **Положительный угол** - камера наклонена вверх
- **Отрицательный угол** - камера наклонена вниз
- **Нулевой угол** - камера горизонтальна

## Алгоритм работы

1. **Предобработка изображения:**
   - Разделение стереопары пополам
   - Извлечение левой половины
   - Ресайз до 1024x512 пикселей
   - Нормализация для нейронной сети

2. **Анализ HorizonNet:**
   - Загрузка предобученной модели ResNet50
   - Извлечение признаков изображения
   - Генерация 1D сигнала горизонта

3. **Вычисление pitch:**
   - Линейная регрессия сигнала горизонта
   - Определение наклона линии
   - Конвертация в угловые градусы

## Структура проекта

```
TiltDetector/
├── pitch_detector.py          # Основной скрипт
├── requirements.txt           # Зависимости
├── README.md                 # Документация
├── test_621_sq2.png         # Тестовое изображение
└── pretrained_models/       # Веса моделей
    ├── resnet50_rnn__zind.pth
    ├── resnet50_rnn__panos2d3d.pth
    ├── resnet50_rnn__st3d.pth
    └── resnet50_rnn__mp3d.pth
```

## Технические детали

### Модель HorizonNet

Используется упрощенная архитектура на основе ResNet50:
- Backbone: ResNet50 (предобученный)
- Head: Адаптивный пулинг + полносвязные слои
- Выход: 128-мерный вектор сигнала горизонта

### Алгоритм вычисления pitch

1. Сигнал горизонта преобразуется в координаты пикселей
2. Применяется линейная регрессия для определения наклона
3. Наклон конвертируется в угловые градусы

### Оптимизация

- Поддержка GPU (CUDA) для ускорения вычислений
- Автоматическое определение доступного устройства
- Эффективная обработка больших изображений

## Возможные улучшения

1. **Повышение точности:**
   - Использование оригинальной архитектуры HorizonNet
   - Добавление дополнительных фильтров
   - Ансамблирование нескольких моделей

2. **Расширение функциональности:**
   - Определение roll и yaw углов
   - Пакетная обработка изображений
   - Экспорт результатов в различные форматы

3. **Улучшение интерфейса:**
   - Визуализация линии горизонта на изображении
   - Интерактивная настройка параметров
   - Сохранение результатов анализа

## Устранение неполадок

### Ошибка загрузки модели
- Убедитесь, что файлы весов находятся в папке `pretrained_models/`
- Проверьте совместимость версий PyTorch

### Ошибка обработки изображения
- Проверьте формат и размер входного изображения
- Убедитесь, что изображение не повреждено

### Медленная работа
- Установите CUDA для ускорения на GPU
- Уменьшите размер обрабатываемого изображения

## Лицензия

Этот проект распространяется под лицензией MIT.

## Авторы

Разработано для автоматического определения угла наклона камеры по стереофотографиям. 